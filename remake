#! /bin/sh

SRCDIR=sources
WDIR=allsrc
THISDIR=`pwd`
M=Makefile
BINNAME=lispi
BINDIR=bin

CFLAGS="-c -Wall -g -pg -D_NO_DEBUG"

if [ ! -e $WDIR ]
then
    mkdir $WDIR
fi


if [ ! -e $BINDIR ]
then
    mkdir $BINDIR
fi

ALLFILES=`ls $SRCDIR`


echo Copying updated files to $WDIR

for F in $ALLFILES
do
   
    if test -d $THISDIR/$SRCDIR/$F 
    then
	cp -uv $THISDIR/$SRCDIR/$F/*.[hc] $WDIR/
    fi
done

echo Changing to directory $WDIR
cd $WDIR



#generation du makefile

OBJECTS=`ls *.c | sed -e 's/\.c/\.o/'`
echo Generating $WDIR/Makefile

echo '# Makefile generated by' $USER > $M
echo "OBJECTS=" $OBJECTS >> $M
echo "CC=gcc" >> $M
echo "CFLAGS=$CFLAGS" >> $M
echo "IFLAGS=-I." >> $M
echo "BINNAME=$BINNAME" >> $M

#regle implicite
echo ".c.o : " >> $M
echo -e "\t" '$(CC) $(CFLAGS) $(IFLAGS) $<' >> $M

#fabrication de l'executable

echo '$(BINNAME) : $(OBJECTS)' >> $M
echo -e "\t" '$(CC) -o $@ -pg  $^' >> $M

gcc -M -I. *.c >> $M

echo Generating Binary File $BINNAME
make


echo Copying $BINNAME to $BINDIR
cp -fv $BINNAME $THISDIR/$BINDIR/

echo Back to $THISDIR !!
cd $THISDIR

